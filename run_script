#!/bin/bash

export BAGEL_NUM_THREADS=1
export OMP_NUM_THREADS=1

ibead=$1
natom=$2
QMnatom=$3
tocalc=$4
nstate=$5

MMnatom=$( echo "$natom-$QMnatom" | bc )
#head of thje file and basis set
cat > bagel.json << EOF
{ "bagel" : [

{
  "title" : "molecule",
  "basis" : "svp",
  "df_basis" : "svp-jkfit",
  "angstrom" : "true",
  "geometry" : [
EOF

#head -n $QMnatom ../geom.dat.$ibead | awk '{print "    { \"atom\" : ""\""$1"\",  \"xyz\" : [  " $2",  "  $3",  "  $4 "]},"}' >> bagel.json #format he geometry from a file
#tail -n+2 pointcharges.xyz | awk '{print "    { \"atom\" : ""\"Q\",  \"xyz\" : [  " $2",  "  $3",  "  $4 "], \"charge\" : " $1 "},"}' >> bagel.json #add the point charge
# Format the geometry from the file with standard decimal notation
head -n $QMnatom ../geom.dat.$ibead | awk '{
    printf "    { \"atom\" : \"%s\",  \"xyz\" : [  %.8f,  %.8f,  %.8f ] },\n", $1, $2, $3, $4
}' >> bagel.json

# Add the point charges with reformatted numbers
tail -n+2 pointcharges.xyz | awk '{
    printf "    { \"atom\" : \"Q\",  \"xyz\" : [  %.8f,  %.8f,  %.8f ], \"charge\" : %.8f },\n", $2, $3, $4, $1
}' >> bagel.json



sed -i '${s/,$//}' bagel.json #remove the very last comma

#specification of the CASSCF
cat >> bagel.json << EOF
  ]
},

{
  "title" : "forces",
  "export" : true,
  "grads" : [
  { "title" : "force", "target" : 0 }
  ],
  "method" : [ {
      "title" : "casscf",
      "nact" : 6,
      "nclosed" : 45,
      "nstate" : 5,
      "maxiter": 250
   } ]
}
]}
EOF


/home/srsen/bin/anaconda3/bin/mpirun -np 1 BAGEL bagel.json > bagel.out


cat > orca1.engrad << EOF
#
# Number of atoms
#
EOF
echo " $QMnatom" >> orca1.engrad
cat >> orca1.engrad << EOF
#
# The current total energy in Eh
#
EOF
head -1 ENERGY.out  >> orca1.engrad
cat >> orca1.engrad << EOF
#
# The current gradient in Eh/bohr
#
EOF
head -n $( echo "$QMnatom+1" | bc ) FORCE*.out | tail -$QMnatom | awk '{print "     " $2}' >> orca1.engrad
head -n $( echo "$QMnatom+1" | bc ) FORCE*.out | tail -$QMnatom | awk '{print "     " $3}' >> orca1.engrad
head -n $( echo "$QMnatom+1" | bc ) FORCE*.out | tail -$QMnatom | awk '{print "     " $4}' >> orca1.engrad

echo $MMnatom > orca1.pcgrad
tail -$MMnatom FORCE*.out | awk '{ print $2 "\t" $3 "\t" $4}' >> orca1.pcgrad

touch orca1.gbw
